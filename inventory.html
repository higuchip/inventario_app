<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventário Florestal</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px; /* Tamanho maior para melhor legibilidade em mobile */
    }
    input[type="number"] {
      -moz-appearance: textfield; /* Firefox */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      width: 100%;
    }
    .back-btn {
      background-color: #607D8B;
      color: white;
    }
    .save-btn {
      background-color: #4CAF50;
      color: white;
    }
    .gps-btn {
      background-color: #2196F3;
      color: white;
      padding: 12px 15px;
      white-space: nowrap;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .button-group button {
      flex: 1;
      min-width: 120px;
    }
    .gps-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .gps-container input {
      flex: 1;
    }
    .gps-container button {
      width: auto;
    }
    /* Estilo para as notificações toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      z-index: 1000;
    }
    .toast {
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      animation: slideIn 0.3s ease-out;
    }
    .toast.success {
      border-left: 4px solid #4CAF50;
    }
    .toast.error {
      border-left: 4px solid #F44336;
    }
    .toast.warning {
      border-left: 4px solid #FFC107;
    }
    .toast-icon {
      margin-right: 10px;
      font-size: 20px;
    }
    .toast-content {
      flex-grow: 1;
    }
    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      .button-group {
        flex-direction: column;
      }
      .button-group button {
        width: 100%;
      }
      .gps-container {
        flex-direction: column;
      }
      .gps-container button {
        width: 100%;
      }
    }
    /* Estilo para o autocomplete personalizado */
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #ddd;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background-color: white;
      border-radius: 0 0 4px 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      color: #333;
      border-bottom: 1px solid #ddd;
    }
    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }
    .autocomplete-active {
      background-color: #1e88e5 !important;
      color: white !important;
    }
    /* Fim do estilo do autocomplete */
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <div class="container">
    <div class="button-group">
      <button class="back-btn" onclick="window.location.href='project.html'">Voltar</button>
    </div>

    <form id="treeForm">
      <div class="form-group">
        <label for="parcela">Parcela:</label>
        <input type="text" id="parcela" required>
      </div>

      <div class="form-group">
        <label for="idArvoreUsuario">ID da Árvore (único):</label>
        <input type="text" id="idArvoreUsuario" required>
      </div>

      <div class="form-group">
        <label for="coordenadas">Coordenadas:</label>
        <div class="gps-container">
          <input type="text" id="coordenadas" readonly>
          <button type="button" class="gps-btn" id="gpsButton">Obter GPS</button>
        </div>
      </div>

      <div class="form-group">
        <label for="especie">Espécie:</label>
        <div class="autocomplete-container">
          <input type="text" id="especie" required autocomplete="off">
          <div id="autocomplete-list" class="autocomplete-items" style="display: none;"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="cap">CAP (cm):</label>
        <input type="number" id="cap" step="0.1" required inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*">
      </div>

      <div class="form-group">
        <label for="altura">Altura (m):</label>
        <input type="number" id="altura" step="0.1" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*">
      </div>

      <div class="form-group">
        <label for="observacao">Observação:</label>
        <textarea id="observacao" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
      </div>

      <div class="button-group">
        <button type="submit" class="save-btn" id="save-update-btn" disabled>Salvar Árvore</button>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        initializeApp();
      } catch (e) {
        console.error('[CRITICAL] Erro durante DOMContentLoaded/initializeApp:', e);
        alert('Erro crítico ao inicializar a página. Funcionalidades podem estar quebradas.');
      }
    });
    
    // Adiciona um listener para pagehide
    window.addEventListener('pagehide', function(event) {
    });

    // Adiciona um listener para pageshow
    window.addEventListener('pageshow', function(event) {
      let dbSeemsValid = false;
      if (db) {
          try {
              db.transaction(['arvores'], 'readonly');
              dbSeemsValid = true;
          } catch (e) {
              console.error('[SW] pageshow: ERRO ao tentar usar conexão DB! Parece inválida.', e);
              db = null;
              alert('A conexão com o banco de dados foi perdida ao voltar. Recarregue a página ou tente novamente.');
          }
      }

      if (event.persisted) {
          if (!dbSeemsValid) {
              initializeApp(); 
          } else {
              loadSpeciesSuggestions(); 
          }
      }
    });

    // Variáveis globais (ou no escopo da função anônima externa, se preferir)
    let db;
    let currentProjectId = null;
    let currentTreeId = null;
    const especiesComuns = [
      "Araucaria angustifolia", "Cedrela fissilis", "Ocotea porosa",
      "Ilex paraguariensis", "Euterpe edulis", "Jacaranda mimosifolia",
      "Handroanthus albus", "Handroanthus impetiginosus",
      "Caesalpinia echinata", "Dalbergia nigra"
    ];
    let todasEspecies = [...especiesComuns];
    let autocompleteSetupDone = false;
    let especieInput;
    let autocompleteList;
    
    // Função principal de inicialização
    function initializeApp() {
      console.log('initializeApp -> Iniciada'); // Log adicionado
      
      especieInput = document.getElementById('especie');
      autocompleteList = document.getElementById('autocomplete-list');

      if (!especieInput || !autocompleteList) {
        console.error('Erro crítico: Elementos Autocomplete não encontrados!');
        alert('Erro: Elementos essenciais da página não foram encontrados.');
        return;
      }

      // Tenta abrir o DB
      const request = indexedDB.open('InventarioDB', 1);

      request.onerror = function(event) {
        console.error('Erro ao abrir IndexedDB:', event.target.error);
        alert('Não foi possível conectar ao banco de dados local. Sugestões podem ser limitadas.');
        todasEspecies = [...especiesComuns];
        setupAutocompleteListeners(); 
      };

      request.onsuccess = function(event) {
        db = event.target.result; 
        
        // --- Validação Robusta de IDs --- 
        let rawProjectId = localStorage.getItem('currentProjectId');
        let rawTreeId = localStorage.getItem('currentTreeId');

        if (!rawProjectId || isNaN(parseInt(rawProjectId))) { 
            alert('ID do Projeto inválido ou não encontrado! Redirecionando...');
            window.location.href = 'project.html';
            return;
        }
        currentProjectId = parseInt(rawProjectId); 

        if (rawTreeId && isNaN(parseInt(rawTreeId))) {
            alert('ID da Árvore inválido! Limpando ID...');
            localStorage.removeItem('currentTreeId');
            rawTreeId = null;
        }
        currentTreeId = rawTreeId ? parseInt(rawTreeId) : null;
        // --- Fim da Validação de IDs ---

        document.getElementById('save-update-btn').disabled = false;

        loadSpeciesSuggestions(); 

        if (currentTreeId) {
          loadTreeData();
        }
      };
      
      setupAutocompleteListeners();
      setupFormSubmitListener();
      
      // ** VERIFICAÇÃO DO LISTENER DO BOTÃO GPS **
      console.log('initializeApp -> Tentando encontrar o botão GPS...'); // Log GPS 1
      const gpsButton = document.getElementById('gpsButton');
      
      if (gpsButton) {
        console.log('initializeApp -> Botão GPS ENCONTRADO!', gpsButton); // Log GPS 2
        try {
           console.log('initializeApp -> Tentando adicionar listener ao botão GPS...'); // Log GPS 3
           gpsButton.addEventListener('click', getLocation);
           console.log('initializeApp -> Listener ADICIONADO ao botão GPS.'); // Log GPS 4
        } catch (e) {
           console.error('initializeApp -> ERRO ao adicionar listener ao botão GPS:', e); // Log GPS Erro
           alert('Erro ao configurar o botão GPS.');
        }
      } else {
        console.error('initializeApp -> ERRO: Botão GPS NÃO encontrado! Verifique o ID no HTML.'); // Log GPS Falha
        alert('Erro crítico: Botão GPS não encontrado na página.');
      }
      // ** FIM DA VERIFICAÇÃO **
    }

    // --- Funções Auxiliares (Autocomplete, DB, Form, etc.) --- 
    // (showSuggestions, setupAutocompleteListeners, loadSpeciesSuggestions, 
    //  loadTreeData, showToast, getLocation permanecem aqui)
    
    function showSuggestions(filter = '') {
      autocompleteList.innerHTML = '';
      autocompleteList.style.display = 'none';

      const lowerFilter = filter.toLowerCase();
      const matches = todasEspecies.filter(especie => 
        especie.toLowerCase().includes(lowerFilter)
      );
      
      if (matches.length === 0) {
        const item = document.createElement('div');
        item.textContent = filter ? 'Nenhuma espécie encontrada' : 'Nenhuma sugestão';
        item.style.padding = '10px';
        item.style.color = '#888';
        autocompleteList.appendChild(item);
      } else {
        matches.forEach(especie => {
          const item = document.createElement('div');
          item.textContent = especie;
          item.style.padding = '10px';
          item.style.cursor = 'pointer';
          
          item.addEventListener('click', function() {
            especieInput.value = especie;
            autocompleteList.style.display = 'none';
          });
          
          item.addEventListener('mouseenter', () => item.style.backgroundColor = '#f0f0f0');
          item.addEventListener('mouseleave', () => item.style.backgroundColor = 'white');
          
          autocompleteList.appendChild(item);
        });
      }
      
      if (matches.length > 0 || !filter) {
           autocompleteList.style.display = 'block';
      } else if (filter && matches.length === 0) {
           autocompleteList.style.display = 'block';
      }
    }
    
    function setupAutocompleteListeners() {
        const oldInput = document.getElementById('especie');

        const handleFocus = () => {
        };
        const handleInput = () => {
            if (especieInput.value.trim() !== '') {
                showSuggestions(especieInput.value);
            } else {
                autocompleteList.style.display = 'none';
            }
        };
        const handleClickOutside = (event) => {
            if (!especieInput.contains(event.target) && !autocompleteList.contains(event.target)) {
                if (autocompleteList.style.display !== 'none') {
                    autocompleteList.style.display = 'none';
                }
            }
        };

        if (oldInput) {
             oldInput.removeEventListener('focus', handleFocus);
             oldInput.removeEventListener('input', handleInput);
        }
        document.removeEventListener('click', handleClickOutside);

        if (especieInput) {
            especieInput.addEventListener('focus', handleFocus);
            especieInput.addEventListener('input', handleInput);
            document.addEventListener('click', handleClickOutside);
            autocompleteSetupDone = true;
        } else {
             console.error('Erro: especieInput não definido ao tentar adicionar listeners!');
        }
    }
    
    function loadSpeciesSuggestions() {
      if (!db) {
        console.warn('DB não pronto para carregar sugestões, usando apenas espécies comuns.');
        todasEspecies = [...especiesComuns];
        setupAutocompleteListeners();
        return;
      }
      
      try {
        const transaction = db.transaction(['arvores'], 'readonly');
        const store = transaction.objectStore('arvores');
        const request = store.getAll();

        request.onsuccess = function() {
          const arvores = request.result;
          const arvoresProjetoAtual = arvores.filter(arvore => arvore.projetoId === currentProjectId);
          const especiesDoProjeto = [...new Set(arvoresProjetoAtual.map(arvore => arvore.especie))].filter(Boolean);
          
          todasEspecies = [...new Set([...especiesComuns, ...especiesDoProjeto])].filter(e => e && e.trim() !== '');
          
          setupAutocompleteListeners(); 
        };

        request.onerror = function(event) {
          console.error('Erro ao buscar árvores no DB para sugestões:', event.target.error);
          todasEspecies = [...especiesComuns];
          setupAutocompleteListeners(); 
        };
      } catch (error) {
        console.error('Erro inesperado em loadSpeciesSuggestions:', error);
        todasEspecies = [...especiesComuns];
        setupAutocompleteListeners();
      }
    }
    
    function loadTreeData() {
      if (!db || !currentTreeId) {
        console.error('loadTreeData: DB não disponível ou ID da árvore não fornecido');
        return;
      }
      
      try {
        const transaction = db.transaction(['arvores'], 'readonly');
        const store = transaction.objectStore('arvores');
        const request = store.get(parseInt(currentTreeId));

        request.onsuccess = function() {
          const arvore = request.result;
          if (!arvore) {
            showToast('Árvore não encontrada. Redirecionando...', 'error');
            setTimeout(() => window.location.href = 'view_trees.html', 2000);
            return;
          }

          document.getElementById('parcela').value = arvore.parcela || '';
          document.getElementById('idArvoreUsuario').value = arvore.idArvoreUsuario || '';
          document.getElementById('especie').value = arvore.especie || '';
          document.getElementById('cap').value = arvore.cap || '';
          document.getElementById('altura').value = arvore.altura || '';
          document.getElementById('coordenadas').value = arvore.coordenadas || '';
          document.getElementById('observacao').value = arvore.observacao || '';
          document.getElementById('save-update-btn').textContent = 'Atualizar Árvore';
        };

        request.onerror = function(event) {
          console.error('Erro ao carregar dados da árvore:', event.target.error);
          showToast('Erro ao carregar dados. Tente novamente.', 'error');
        };
      } catch (error) {
        console.error('Erro em loadTreeData:', error);
        showToast('Erro ao acessar o banco de dados', 'error');
      }
    }
    
    function showToast(message, type = 'success') {
      console.log(`showToast -> Chamada com: "${message}", Tipo: ${type}`); // Log Toast 1
      
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
          console.error('showToast -> ERRO: Elemento toastContainer não encontrado!'); // Log Toast Erro
          // Fallback para alert se o container não existe
          alert(`(${type}): ${message}`); 
          return; 
      }
      
      console.log('showToast -> toastContainer encontrado.', toastContainer); // Log Toast 2
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : '⚠';
      
      toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <div class="toast-content">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
      `;
      
      console.log('showToast -> Adicionando toast ao container...'); // Log Toast 3
      toastContainer.appendChild(toast);
      console.log('showToast -> Toast adicionado.'); // Log Toast 4
      
      // Remove a notificação após 5 segundos
      setTimeout(() => {
        // console.log('showToast -> Removendo toast após timeout.'); // Log opcional
        if (toast && toast.parentElement) { // Verifica se ainda existe
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }
      }, 5000);
    }
    
    function getLocation() {
      console.log('getLocation -> Iniciada'); // Log 1
      
      if (navigator.geolocation) {
        console.log('getLocation -> navigator.geolocation existe.'); // Log 2
        
        //showToast('Obtendo localização... Aguarde.', 'warning'); // Feedback inicial

        navigator.geolocation.getCurrentPosition(
          function(position) {
            // Callback de SUCESSO
            console.log('getLocation -> getCurrentPosition -> Sucesso!', position); // Log 3a
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const coordInput = document.getElementById('coordenadas');
            
            if (coordInput) {
              console.log(`getLocation -> Definindo coordenadas: ${lat}, ${lng}`); // Log 4a
              coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
              console.log('getLocation -> Chamando showToast de sucesso...'); // Log 5a
              showToast('Coordenadas obtidas com sucesso!', 'success');
            } else {
              console.error('getLocation -> Elemento de coordenadas não encontrado!');
              alert('Erro interno: Campo de coordenadas não encontrado.'); // Fallback alert
            }
          },
          function(error) {
            // Callback de ERRO
            console.error('getLocation -> getCurrentPosition -> ERRO!', error); // Log 3b
            // Log detalhado do código e mensagem do erro
            console.error(`Código do erro: ${error.code}, Mensagem: ${error.message}`); 
            
            let userMessage = 'Erro ao obter localização: ' + error.message;
            // Mensagens mais amigáveis para erros comuns
            if (error.code === error.PERMISSION_DENIED) {
                userMessage = 'Permissão de localização negada. Verifique as configurações do navegador/site.';
            } else if (error.code === error.POSITION_UNAVAILABLE) {
                userMessage = 'Informação de localização indisponível no momento.';
            } else if (error.code === error.TIMEOUT) {
                userMessage = 'Tempo esgotado ao tentar obter localização.';
            }
            
            console.log('getLocation -> Chamando showToast de erro...'); // Log 5b
            showToast(userMessage, 'error');
          },
          {
            enableHighAccuracy: true, 
            timeout: 10000, 
            maximumAge: 0 
          }
        );
        console.log('getLocation -> Chamada para getCurrentPosition realizada.'); // Log 6
      } else {
        console.warn('getLocation -> navigator.geolocation NÃO existe.'); // Log 2 negado
        showToast('Geolocalização não é suportada neste navegador.', 'error');
      }
      console.log('getLocation -> Finalizada.'); // Log 7
    }
    
    // Nova função para encapsular o listener do form
    function setupFormSubmitListener() {
        const form = document.getElementById('treeForm');
        if (!form.dataset.listenerAttached) {
             form.addEventListener('submit', function handleFormSubmit(event) {
                event.preventDefault();
                               
                const idArvoreUsuarioValue = document.getElementById('idArvoreUsuario').value.trim();
                const especieValue = document.getElementById('especie').value.trim();
                const capValue = parseFloat(document.getElementById('cap').value);
                const alturaInput = document.getElementById('altura').value;
                let alturaValue = alturaInput ? parseFloat(alturaInput) : null;
        
                if (especieValue === '') {
                   showToast('O campo Espécie é obrigatório.', 'error');
                   return;
                }
                // Validar o Id da Arvore (se for informado)
                if (idArvoreUsuarioValue === '') {
                   // Esta validação é uma segurança extra, 'required' deve pegar antes
                   showToast('O campo ID da Árvore é obrigatório.', 'error');
                   return;
                }
                // Validar o CAP
                if (isNaN(capValue)) {
                    showToast('Valor inválido para CAP.', 'error');
                    return;
                }
                if (alturaInput && isNaN(alturaValue)) {
                    showToast('Valor inválido para Altura.', 'error');
                    return;
                }
        
                const arvore = {
                   parcela: document.getElementById('parcela').value.trim(),
                   idArvoreUsuario: idArvoreUsuarioValue,
                   especie: especieValue,
                   cap: capValue,
                   altura: alturaValue,
                   coordenadas: document.getElementById('coordenadas').value || null,
                   observacao: document.getElementById('observacao').value || null,
                   projetoId: currentProjectId,
                   dataRegistro: new Date().toISOString()
                };
        
                if (!db) {
                     console.error('DB não disponível ao tentar salvar!');
                     showToast('Erro: Conexão com banco de dados perdida.', 'error');
                     return;
                }
                
                const transaction = db.transaction(['arvores'], 'readwrite');
                const store = transaction.objectStore('arvores');
                let request;
                
                if (currentTreeId) { 
                  arvore.id = currentTreeId;
                  request = store.put(arvore);
                } else {
                  request = store.add(arvore);
                }
        
                request.onsuccess = function() {
                   showToast(currentTreeId ? 'Árvore atualizada!' : 'Árvore salva!');
                   if (!currentTreeId) {
                      loadSpeciesSuggestions();
                      document.getElementById('treeForm').reset();
                      document.getElementById('save-update-btn').textContent = 'Salvar Árvore';
                   } else {
                      setTimeout(() => window.location.href = 'view_trees.html', 1500);
                   }
                };
        
                request.onerror = function(event) {
                   console.error('Erro ao salvar árvore:', event.target.error);
                   showToast('Erro ao salvar a árvore.', 'error');
                };
             });
             form.dataset.listenerAttached = 'true';
        }
    }
  </script>
</body>
</html>
